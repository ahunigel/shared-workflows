name: Set environment variable

on:
  workflow_call:
    inputs:
      env-name:
        required: true
        type: string
      env-json:
        required: true
        type: string
    secrets:
      staging-credentials:
        required: true
      production-credentials:
        required: true
    outputs:
      deploy-to:
        description: "Target environment to deploy"
        value: ${{ jobs.set-params.outputs.deploy-to }}
      cluster-name:
        description: "Cluster name"
        value: ${{ jobs.set-params.outputs.cluster-name }}
      resource-group:
        description: "Resource group"
        value: ${{ jobs.set-params.outputs.resource-group }}
      azure-credentials:
        description: "azure credential"
        value: ${{ jobs.set-params.outputs.azure-credentials }}
jobs:
  set-params:
    runs-on: ubuntu-latest
    outputs:
      deploy-to: ${{ steps.setValue.outputs.deploy-to }}
      cluster-name: ${{ steps.setValue.outputs.cluster-name }}
      resource-group: ${{ steps.setValue.outputs.resource-group }}
      azure-credentials: ${{ steps.setCredentials.outputs.azure-credentials }}
    steps:
      - id: setValue
        name: set values for ${{ inputs.env-name }}
        run: |
          echo input is '${{ toJson(fromJson(inputs.env-json)[inputs.env-name]) }}'
          echo '::set-output name=deploy-to::${{ fromJson(inputs.env-json)[inputs.env-name].deploy-to }}'
          echo ::set-output name=cluster-name::${{ fromJson(inputs.env-json)[inputs.env-name].cluster-name }}
          echo ::set-output name=resource-group::${{ fromJson(inputs.env-json)[inputs.env-name].resource-group }}

      - id: setCredentials
        name: set credentials for ${{ inputs.env-name }}
        run: |
          echo '${{ secrets.staging-credentials }}' | sed 's/\n/& /g'
          if ${{ inputs.env-name =='staging'}}
          then
            echo 'setting staging'
            echo '::set-output name=azure-credentials::${{ toJson(secrets.staging-credentials) }}'
          else
            echo 'setting staging'
            echo '::set-output name=azure-credentials::${{ toJson(secrets.production-credentials) }}'
          fi